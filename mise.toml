[tools]
go = "latest"
svu = "latest"
changie = "latest"

[tasks.test]
run = "go test ./..."

[tasks.build]
run = """
go build -ldflags "\
  -X hmans.dev/beans/cmd/beans.version=$(git describe --tags --always --dirty 2>/dev/null || echo dev) \
  -X hmans.dev/beans/cmd/beans.commit=$(git rev-parse --short HEAD 2>/dev/null || echo unknown) \
  -X hmans.dev/beans/cmd/beans.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
  .
"""

[tasks.install]
depends = "build"
run = "cp beans ~/.local/bin/beans"

[tasks.changelog]
description = "Add a new changelog entry (interactive)"
run = "changie new"

[tasks."release"]
description = "Release with auto-detected version based on changelog entries"
run = """
set -e

# Check for unreleased changes
if [ -z "$(ls -A .changes/unreleased/*.yaml 2>/dev/null)" ]; then
  echo "No unreleased changes found. Add changes with: mise changelog"
  exit 1
fi

# Determine new version and confirm
NEW_VERSION=$(changie next auto)
echo "About to release: $NEW_VERSION"
read -p "Continue? [y/N] " confirm
if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
  echo "Aborted."
  exit 1
fi

# Actually perform the release
changie batch auto
changie merge
git add CHANGELOG.md .changes/
git commit -m "chore: release $NEW_VERSION"
git tag "$NEW_VERSION"
git push origin main "$NEW_VERSION"
echo "Released $NEW_VERSION"
"""
